/**
 * Synchronize.js
 * Version 1.2.1
 *
 *  Copyright (C) 2013-2015 Denis Meyer, calltopower88@googlemail.com
 *  This program is free software; you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation; either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along
 *  with this program; if not, write to the Free Software Foundation, Inc.,
 *  51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
 */
(function(e){function B(e){if(g&&window.console){console.log(e)}}function j(e,t,n){if(!isNaN(e)&&!isNaN(t)&&!isNaN(n)&&t<=n){return e>=t&&e<=n}else{return false}}function F(t){if(t){if(!q()){return e("#"+t)}else{return videojs(t)}}else{B("SJS: [getVideoObj] Undefined video element id '"+t+"'");return undefined}}function I(e){if(e){if(!q()){return F(e).get(0)}else{return videojs(e)}}else{B("SJS: [getVideo] Undefined video element id '"+e+"'");return undefined}}function q(){return!(typeof videojs==="undefined")}function R(e){if(q()&&e){var t=e.id();return t!=""?t:e}else{return e}}function U(e){if(e){B("SJS: [play] Playing video element id '"+e+"'");I(e).play();return true}else{B("SJS: [play] Undefined video element id '"+e+"'");return false}}function z(e){if(e){B("SJS: [mute] Muting video element id '"+e+"'");if(!q()){I(e).muted=true}else{I(e).volume(0)}}else{B("SJS: [mute] Undefined video element id '"+e+"'");return undefined}}function W(e){if(e){B("SJS: [pause] Pausing video element id '"+e+"'");return I(e).pause()}else{B("SJS: [pause] Undefined video element id '"+e+"'");return false}}function X(e){if(e){if(!q()){return I(e).paused}else{return I(e).paused()}}else{B("SJS: [isPaused] Undefined video element id '"+e+"'");return false}}function V(e){if(e){if(!q()){return I(e).duration}else{return I(e).duration()}}else{B("SJS: [getDuration] Undefined video element id '"+e+"'");return-1}}function $(e){if(e){if(!q()){return I(e).currentTime}else{return I(e).currentTime()}}else{B("SJS: [getCurrentTime] Undefined video element id '"+e+"'");return-1}}function J(e,t){if(e){var n=V(e);if(n!=-1&&!isNaN(t)&&t>=0&&t<=n){if(!q()){I(e).currentTime=t}else{I(e).currentTime(t)}return true}else{B("SJS: [setCurrentTime] Could not set time for video element id '"+e+"'");J(e,n);return false}}else{B("SJS: [setCurrentTime] Undefined video element id '"+e+"'");return false}}function K(e){if(e){if(!q()){return I(e).playbackRate}else{return I(e).playbackRate()}}else{B("SJS: [getPlaybackRate] Undefined video element id '"+e+"'");return 1}}function Q(e,t){if(e){if(!q()){I(e).playbackRate=t}else{I(e).playbackRate(t)}return true}else{B("SJS: [setPlaybackRate] Undefined video element id '"+e+"'");return false}}function G(e){if(e){if(!q()){return I(e).buffered}else{return I(e).buffered()}}else{B("SJS: [getBufferTimeRange] Undefined video element id '"+e+"'");return undefined}}function Y(e){var t=$(S);var n=$(e);if(t!=-1&&n!=-1&&!j(n,t-a,t)){return n-t}return 0}function Z(){for(var t=0;t<y.length;++t){if(y[t]!=S){var n=false;var r=Y(y[t]);if(!H){if(r>d){if(Math.abs(r)<f){e(document).trigger("sjs:synchronizing",[$(S),y[t]]);B("SJS: [synchronize] Decreasing playback rate of video element id '"+y[t]+"' from "+K(y[t])+" to "+(K(S)-.5));Q(y[t],K(S)+c)}else{e(document).trigger("sjs:synchronizing",[$(S),y[t]]);Q(y[t],K(S));n=true}}else if(r<v){if(Math.abs(r)<f){e(document).trigger("sjs:synchronizing",[$(S),y[t]]);B("SJS: [synchronize] Increasing playback rate of video element id '"+y[t]+"' from "+K(y[t])+" to "+(K(S)-.5));Q(y[t],K(S)+l)}else{e(document).trigger("sjs:synchronizing",[$(S),y[t]]);Q(y[t],K(S));n=true}}else if(!X(S)&&!P[y[t]]){Q(y[t],K(S));B("SJS: [synchronize] Playing video element id '"+y[t]+"'");U(y[t])}}else if(H){if(Math.abs(r)>m&&Math.abs(r)>p){n=true}else if(!X(S)&&!P[y[t]]){B("SJS: [synchronize] Playing video element id '"+y[t]+"'");U(y[t])}}if(n){e(document).trigger("sjs:synchronizing",[$(S),y[t]]);B("SJS: [synchronize] Seeking video element id '"+y[t]+"': "+($(S)+h));if(J(y[t],$(S)+h)){U(y[t]);if(!X(S)&&!P[y[t]]){B("SJS: [synchronize] Playing video element id '"+y[t]+"' after seeking");U(y[t])}else{B("SJS: [synchronize] Pausing video element id '"+y[t]+"' after seeking");W(y[t])}}}}}}function et(e,t){B("SJS: [syncPause] Synchronizing. Pausing video id '"+e+"' for "+t/K(S)+"s");P[e]=true;W(e);setTimeout(function(){P[e]=false;if(!X(S)){U(e);B("SJS: [syncPause] Synchronizing. Continuing to play video id '"+e+"' after "+t+"s")}else{B("SJS: [syncPause] Still pausing video id '"+e+"' after "+t+"s, as the master video is paused, too")}},t/K(S)*1e3)}function tt(){if(st()){var n=F(S);H=e("#"+S+"_flash_api").length!=0;n.on("play",function(){B("SJS: Master received 'play' event");e(document).trigger("sjs:masterPlay",[$(S)]);A=false;if(!N&&t){N=true;nt()}for(var n=0;n<y.length;++n){if(y[n]!=S){U(y[n]);z(y[n])}}});n.on("pause",function(){B("SJS: Master received 'pause' event");e(document).trigger("sjs:masterPause",[$(S)]);A=!L&&k;L=L?!L:L;for(var t=0;t<y.length;++t){if(y[t]!=S){W(y[t]);Z()}}});n.on("ratechange",function(){B("SJS: Master received 'ratechange' event");e(document).trigger("sjs:masterPlaybackRateChanged",[K(S)]);for(var t=0;t<y.length;++t){if(y[t]!=S){Q(y[t],K(S))}}});n.on("ended",function(){B("SJS: Master received 'ended' event");e(document).trigger("sjs:masterEnded",[V(S)]);A=true;for(var t=0;t<y.length;++t){if(y[t]!=S){Z();W(y[t])}}});n.on("timeupdate",function(){e(document).trigger("sjs:masterTimeupdate",[$(S)]);A=true;var t=Date.now();if(t-o>u||X(S)){o=t;var n;var r;for(var i=0;i<y.length;++i){if(y[i]!=S){z(y[i]);r=X(y[i]);Z()}}}})}else{for(var r=0;r<y.length;++r){W(y[r])}}}function nt(){C=window.setInterval(function(){var t=true;var n=$(S);for(var r=0;r<y.length;++r){var s=G(y[r]);if(s){var o=V(y[r]);var u=$(y[r])+i;var a=false;for(var f=0;f<s.length&&!a;++f){u=u>=o?o:u;if(j(u,s.start(f),s.end(f))){a=true}}t=t&&a}else{}}if(!t){k=true;L=true;for(var r=0;r<y.length;++r){W(y[r])}A=false;e(document).trigger("sjs:buffering",[])}else if(k&&!A){k=false;U(S);A=false;e(document).trigger("sjs:bufferedAndAutoplaying",[])}else if(k){k=false;e(document).trigger("sjs:bufferedButNotAutoplaying",[])}},n)}function rt(t){E=t<y.length?t:0;S=y[E];e(document).trigger("sjs:masterSet",[S])}function it(e,t){if(e!=""){F(e).on("loadeddata",function(){_=true;if(t){t()}})}else{B("SJS: [doWhenDataLoaded] Undefined video element id '"+e+"'")}}function st(){if(!q()){return x==y.length}else{for(var e=0;e<y.length;++e){if(!w[y[e]]){return false}}return true}}function ot(){if(!q()){return x==y.length}else{for(var e=0;e<y.length;++e){if(!b[y[e]]){return false}}return true}}function ut(){var e=this;for(var t=0;t<y.length;++t){W(y[t])}T=true}function at(){var e=this;for(var t=0;t<y.length;++t){W(y[t])}T=false}function ft(){if(O!=null){window.clearInterval(O);O=null}}var t=true;var n=1e3;var r=5e3;var i=2;var s=true;var o=0;var u=1e3;var a=1;var f=4;var l=.5;var c=-.5;var h=.25;var p=h+.05;var d=.05;var v=-.05;var m=.05;var g=false;var y=[];var b={};var w={};var E=0;var S;var x=0;var T=false;var N=false;var C;var k=false;var L=false;var A=false;var O=null;var M=1e4;var _=false;var D=null;var P=[];var H=false;e.synchronizeVideos=function(t,n,i){var o=true;if(arguments.length==2){var u=e('video[mediagroup="'+n+'"]');for(var a=0;a<u.length;++a){var f=y.length;y[f]=u[a].getAttribute("id");var l="_html5_api";y[f]=q()&&y[f].indexOf(l)!=-1?y[f].substr(0,y[f].length-l.length):y[f];b[y[a-1]]=false;w[y[a-1]]=false}}else{E=t;for(var a=1;a<arguments.length;++a){o=o&&arguments[a]&&e("#"+arguments[a]).length;if(!o){e(document).trigger("sjs:invalidId",[arguments[a]])}else{y[y.length]=arguments[a];b[y[a-1]]=false;w[y[a-1]]=false}}}if(o&&y.length>1){if(!q()){for(var a=0;a<y.length;++a){e(document).trigger("sjs:idRegistered",[y[a]]);var c=t;F(y[a]).on("play",ut);F(y[a]).on("pause",at);F(y[a]).ready(function(){++x;if(st()){rt(c);for(var t=0;t<y.length;++t){F(y[t]).off("play",ut);F(y[t]).off("pause",at)}tt();if(T){U(S)}e(document).trigger("sjs:allPlayersReady",[])}})}}else{for(var a=0;a<y.length;++a){e(document).trigger("sjs:idRegistered",[y[a]]);var c=t;F(y[a]).on("play",ut);F(y[a]).on("pause",at);F(y[a]).ready(function(){var t=R(this);b[t]=true;it(t,function(){w[t]=true;e(document).trigger("sjs:playerLoaded",[t]);if(st()){rt(c);for(var n=0;n<y.length;++n){F(y[n]).off("play",ut);F(y[n]).off("pause",at)}tt();if(T){U(S)}e(document).trigger("sjs:allPlayersReady",[])}});D=window.setInterval(function(){if(!_){for(var e=0;e<y.length;++e){F(y[e]).trigger("loadeddata")}}else{window.clearInterval(D);D=null}},r)})}}}else{B("SJS: Not enough videos");e(document).trigger("sjs:notEnoughVideos",[])}if(s){e(document).on("sjs:buffering",function(e){B("SJS: Received 'sjs:buffering' event");O=setInterval(function(){if(st()&&!A){U(S)}},M)});e(document).on("sjs:bufferedAndAutoplaying",function(e){B("SJS: Received 'sjs:bufferedAndAutoplaying' event");ft()});e(document).on("sjs:bufferedButNotAutoplaying",function(e){B("SJS: Received 'sjs:bufferedButNotAutoplaying' event");ft()})}e(document).on("sjs:play",function(e){B("SJS: Received 'sjs:play' event");if(st()){U(S)}});e(document).on("sjs:pause",function(e){B("SJS: Received 'sjs:pause' event");if(st()){W(S)}});e(document).on("sjs:setCurrentTime",function(e,t){B("SJS: Received 'sjs:setCurrentTime' event");if(st()){J(S,t)}});e(document).on("sjs:synchronize",function(e){B("SJS: Received 'sjs:synchronize' event");if(st()){Z()}});e(document).on("sjs:startBufferChecker",function(e){B("SJS: Received 'sjs:startBufferChecker' event");if(!N){window.clearInterval(C);N=true;nt()}});e(document).on("sjs:stopBufferChecker",function(e){B("SJS: Received 'sjs:stopBufferChecker' event");window.clearInterval(C);N=false})};e(document).on("sjs:debug",function(e,t){g=t;B("SJS: Received 'sjs:debug' event")})})(jQuery)