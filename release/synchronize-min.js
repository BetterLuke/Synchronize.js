/**
 * Synchronize.js
 * Version 1.2.1
 *
 *  Copyright (C) 2013-2015 Denis Meyer, calltopower88@googlemail.com
 *  This program is free software; you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation; either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along
 *  with this program; if not, write to the Free Software Foundation, Inc.,
 *  51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
 */
(function(e){function _(e){if(t&&window.console){console.log(e)}}function D(e,t,n){if(!isNaN(e)&&!isNaN(t)&&!isNaN(n)&&t<=n){return e>=t&&e<=n}else{return false}}function P(t){if(t){if(!B()){return e("#"+t)}else{return videojs(t)}}else{_("SJS: [getVideoObj] Undefined video element id '"+t+"'");return undefined}}function H(e){if(e){if(!B()){return P(e).get(0)}else{return videojs(e)}}else{_("SJS: [getVideo] Undefined video element id '"+e+"'");return undefined}}function B(){return!(typeof videojs==="undefined")}function j(e){if(B()&&e){var t=e.id();return t!=""?t:e}else{return e}}function F(e){if(e){_("SJS: [play] Playing video element id '"+e+"'");H(e).play();return true}else{_("SJS: [play] Undefined video element id '"+e+"'");return false}}function I(e){if(e){_("SJS: [mute] Muting video element id '"+e+"'");if(!B()){H(e).muted=true}else{H(e).volume(0)}}else{_("SJS: [mute] Undefined video element id '"+e+"'");return undefined}}function q(e){if(e){_("SJS: [pause] Pausing video element id '"+e+"'");return H(e).pause()}else{_("SJS: [pause] Undefined video element id '"+e+"'");return false}}function R(e){if(e){if(!B()){return H(e).paused}else{return H(e).paused()}}else{_("SJS: [isPaused] Undefined video element id '"+e+"'");return false}}function U(e){if(e){if(!B()){return H(e).duration}else{return H(e).duration()}}else{_("SJS: [getDuration] Undefined video element id '"+e+"'");return-1}}function z(e){if(e){if(!B()){return H(e).currentTime}else{return H(e).currentTime()}}else{_("SJS: [getCurrentTime] Undefined video element id '"+e+"'");return-1}}function W(e,t){if(e){var n=U(e);if(n!=-1&&!isNaN(t)&&t>=0&&t<=n){if(!B()){H(e).currentTime=t}else{H(e).currentTime(t)}return true}else{_("SJS: [setCurrentTime] Could not set time for video element id '"+e+"'");W(e,n);return false}}else{_("SJS: [setCurrentTime] Undefined video element id '"+e+"'");return false}}function X(e){if(e){if(!B()){return H(e).playbackRate}else{return H(e).playbackRate()}}else{_("SJS: [getPlaybackRate] Undefined video element id '"+e+"'");return 1}}function V(e,t){if(e){if(!B()){H(e).playbackRate=t}else{H(e).playbackRate(t)}return true}else{_("SJS: [setPlaybackRate] Undefined video element id '"+e+"'");return false}}function $(e){if(e){if(!B()){return H(e).buffered}else{return H(e).buffered()}}else{_("SJS: [getBufferTimeRange] Undefined video element id '"+e+"'");return undefined}}function J(e){var t=z(o);var n=z(e);if(t!=-1&&n!=-1&&!D(n,t-l,t)){return n-t}return 0}function K(){for(var t=0;t<n.length;++t){if(n[t]!=o){var r=false;var i=J(n[t]);if(!M){if(i>d){if(i<c){e(document).trigger("sjs:synchronizing",[z(o),n[t]]);_("SJS: [synchronize] Decreasing playback rate of video element id '"+n[t]+"' from "+X(n[t])+" to "+(X(o)-.5));V(n[t],X(o)-.5)}else{e(document).trigger("sjs:synchronizing",[z(o),n[t]]);V(n[t],X(o));q(n[t])}}else if(i<d){if(i<c){e(document).trigger("sjs:synchronizing",[z(o),n[t]]);_("SJS: [synchronize] Increasing playback rate of video element id '"+n[t]+"' from "+X(n[t])+" to "+(X(o)+.5));V(n[t],X(o)+.5)}else{V(n[t],X(o));r=true}}else if(!R(o)&&!O[n[t]]){_("SJS: [synchronize] Playing video element id '"+n[t]+"'");F(n[t])}}else if(M){if(Math.abs(i)>d&&Math.abs(i)>p){r=true}else if(!R(o)&&!O[n[t]]){_("SJS: [synchronize] Playing video element id '"+n[t]+"'");F(n[t])}}if(r){e(document).trigger("sjs:synchronizing",[z(o),n[t]]);_("SJS: [synchronize] Seeking video element id '"+n[t]+"': "+(z(o)+h));if(W(n[t],z(o)+h)){F(n[t]);if(!R(o)&&!O[n[t]]){_("SJS: [synchronize] Playing video element id '"+n[t]+"' after seeking");F(n[t])}else{_("SJS: [synchronize] Pausing video element id '"+n[t]+"' after seeking");q(n[t])}}}}}}function Q(e,t){_("SJS: [syncPause] Synchronizing. Pausing video id '"+e+"' for "+t/X(o)+"s");O[e]=true;q(e);setTimeout(function(){O[e]=false;if(!R(o)){F(e);_("SJS: [syncPause] Synchronizing. Continuing to play video id '"+e+"' after "+t+"s")}else{_("SJS: [syncPause] Still pausing video id '"+e+"' after "+t+"s, as the master video is paused, too")}},t/X(o)*1e3)}function G(){if(tt()){var t=P(o);M=e("#"+o+"_flash_api").length!=0;t.on("play",function(){_("SJS: Master received 'play' event");e(document).trigger("sjs:masterPlay",[z(o)]);S=false;if(!g&&m){g=true;Y()}for(var t=0;t<n.length;++t){if(n[t]!=o){F(n[t]);I(n[t])}}});t.on("pause",function(){_("SJS: Master received 'pause' event");e(document).trigger("sjs:masterPause",[z(o)]);S=!E&&w;E=E?!E:E;for(var t=0;t<n.length;++t){if(n[t]!=o){q(n[t]);K()}}});t.on("ratechange",function(){_("SJS: Master received 'ratechange' event");e(document).trigger("sjs:masterPlaybackRateChanged",[X(o)]);for(var t=0;t<n.length;++t){if(n[t]!=o){V(n[t],X(o))}}});t.on("ended",function(){_("SJS: Master received 'ended' event");e(document).trigger("sjs:masterEnded",[U(o)]);S=true;for(var t=0;t<n.length;++t){if(n[t]!=o){K();q(n[t])}}});t.on("timeupdate",function(){e(document).trigger("sjs:masterTimeupdate",[z(o)]);S=true;var t=Date.now();if(t-a>f||R(o)){a=t;var r;var i;for(var s=0;s<n.length;++s){if(n[s]!=o){I(n[s]);i=R(n[s]);K()}}}})}else{for(var r=0;r<n.length;++r){q(n[r])}}}function Y(){y=window.setInterval(function(){var t=true;var r=z(o);for(var i=0;i<n.length;++i){var s=$(n[i]);if(s){var u=U(n[i]);var a=z(n[i])+x;var f=false;for(var l=0;l<s.length&&!f;++l){a=a>=u?u:a;if(D(a,s.start(l),s.end(l))){f=true}}t=t&&f}else{}}if(!t){w=true;E=true;for(var i=0;i<n.length;++i){q(n[i])}S=false;e(document).trigger("sjs:buffering",[])}else if(w&&!S){w=false;F(o);S=false;e(document).trigger("sjs:bufferedAndAutoplaying",[])}else if(w){w=false;e(document).trigger("sjs:bufferedButNotAutoplaying",[])}},b)}function Z(t){s=t<n.length?t:0;o=n[s];e(document).trigger("sjs:masterSet",[o])}function et(e,t){if(e!=""){P(e).on("loadeddata",function(){k=true;if(t){t()}})}else{_("SJS: [doWhenDataLoaded] Undefined video element id '"+e+"'")}}function tt(){if(!B()){return u==n.length}else{for(var e=0;e<n.length;++e){if(!i[n[e]]){return false}}return true}}function nt(){if(!B()){return u==n.length}else{for(var e=0;e<n.length;++e){if(!r[n[e]]){return false}}return true}}function rt(){var e=this;for(var t=0;t<n.length;++t){q(n[t])}v=true}function it(){var e=this;for(var t=0;t<n.length;++t){q(n[t])}v=false}function st(){if(N!=null){window.clearInterval(N);N=null}}var t=false;var n=[];var r={};var i={};var s=0;var o;var u=0;var a=0;var f=1500;var l=1;var c=5;var h=.25;var p=h+.05;var d=0;var v=false;var m=true;var g=false;var y;var b=1e3;var w=false;var E=false;var S=false;var x=2;var T=true;var N=null;var C=1e4;var k=false;var L=null;var A=5e3;var O=[];var M=false;e.synchronizeVideos=function(a,f,l){var c=true;if(arguments.length==2){var h=e('video[mediagroup="'+f+'"]');for(var p=0;p<h.length;++p){var d=n.length;n[d]=h[p].getAttribute("id");var m="_html5_api";n[d]=B()&&n[d].indexOf(m)!=-1?n[d].substr(0,n[d].length-m.length):n[d];r[n[p-1]]=false;i[n[p-1]]=false}}else{s=a;for(var p=1;p<arguments.length;++p){c=c&&arguments[p]&&e("#"+arguments[p]).length;if(!c){e(document).trigger("sjs:invalidId",[arguments[p]])}else{n[n.length]=arguments[p];r[n[p-1]]=false;i[n[p-1]]=false}}}if(c&&n.length>1){if(!B()){for(var p=0;p<n.length;++p){e(document).trigger("sjs:idRegistered",[n[p]]);var b=a;P(n[p]).on("play",rt);P(n[p]).on("pause",it);P(n[p]).ready(function(){++u;if(tt()){Z(b);for(var t=0;t<n.length;++t){P(n[t]).off("play",rt);P(n[t]).off("pause",it)}G();if(v){F(o)}e(document).trigger("sjs:allPlayersReady",[])}})}}else{for(var p=0;p<n.length;++p){e(document).trigger("sjs:idRegistered",[n[p]]);var b=a;P(n[p]).on("play",rt);P(n[p]).on("pause",it);P(n[p]).ready(function(){var t=j(this);r[t]=true;et(t,function(){i[t]=true;e(document).trigger("sjs:playerLoaded",[t]);if(tt()){Z(b);for(var r=0;r<n.length;++r){P(n[r]).off("play",rt);P(n[r]).off("pause",it)}G();if(v){F(o)}e(document).trigger("sjs:allPlayersReady",[])}});L=window.setInterval(function(){if(!k){for(var e=0;e<n.length;++e){P(n[e]).trigger("loadeddata")}}else{window.clearInterval(L);L=null}},A)})}}}else{_("SJS: Not enough videos");e(document).trigger("sjs:notEnoughVideos",[])}if(T){e(document).on("sjs:buffering",function(e){_("SJS: Received 'sjs:buffering' event");N=setInterval(function(){if(tt()&&!S){F(o)}},C)});e(document).on("sjs:bufferedAndAutoplaying",function(e){_("SJS: Received 'sjs:bufferedAndAutoplaying' event");st()});e(document).on("sjs:bufferedButNotAutoplaying",function(e){_("SJS: Received 'sjs:bufferedButNotAutoplaying' event");st()})}e(document).on("sjs:play",function(e){_("SJS: Received 'sjs:play' event");if(tt()){F(o)}});e(document).on("sjs:pause",function(e){_("SJS: Received 'sjs:pause' event");if(tt()){q(o)}});e(document).on("sjs:setCurrentTime",function(e,t){_("SJS: Received 'sjs:setCurrentTime' event");if(tt()){W(o,t)}});e(document).on("sjs:debug",function(e,n){_("SJS: Received 'sjs:debug' event");t=n});e(document).on("sjs:synchronize",function(e){_("SJS: Received 'sjs:synchronize' event");if(tt()){K()}});e(document).on("sjs:startBufferChecker",function(e){_("SJS: Received 'sjs:startBufferChecker' event");if(!g){window.clearInterval(y);g=true;Y()}});e(document).on("sjs:stopBufferChecker",function(e){_("SJS: Received 'sjs:stopBufferChecker' event");window.clearInterval(y);g=false})}})(jQuery)