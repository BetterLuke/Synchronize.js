/**
 * Synchronize.js
 * Version 1.2.1
 *
 *  Copyright (C) 2013-2015 Denis Meyer, calltopower88@googlemail.com
 *  This program is free software; you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation; either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along
 *  with this program; if not, write to the Free Software Foundation, Inc.,
 *  51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
 */
(function(e){function H(e){if(m&&window.console){console.log(e)}}function B(e,t,n){if(!isNaN(e)&&!isNaN(t)&&!isNaN(n)&&t<=n){return e>=t&&e<=n}else{return false}}function j(t){if(t){if(!I()){return e("#"+t)}else{return videojs(t)}}else{H("SJS: [getVideoObj] Undefined video element id '"+t+"'");return undefined}}function F(e){if(e){if(!I()){return j(e).get(0)}else{return videojs(e)}}else{H("SJS: [getVideo] Undefined video element id '"+e+"'");return undefined}}function I(){return!(typeof videojs==="undefined")}function q(e){if(I()&&e){var t=e.id();return t!=""?t:e}else{return e}}function R(e){if(e){H("SJS: [play] Playing video element id '"+e+"'");F(e).play();return true}else{H("SJS: [play] Undefined video element id '"+e+"'");return false}}function U(e){if(e){H("SJS: [mute] Muting video element id '"+e+"'");if(!I()){F(e).muted=true}else{F(e).volume(0)}}else{H("SJS: [mute] Undefined video element id '"+e+"'");return undefined}}function z(e){if(e){H("SJS: [pause] Pausing video element id '"+e+"'");return F(e).pause()}else{H("SJS: [pause] Undefined video element id '"+e+"'");return false}}function W(e){if(e){if(!I()){return F(e).paused}else{return F(e).paused()}}else{H("SJS: [isPaused] Undefined video element id '"+e+"'");return false}}function X(e){if(e){if(!I()){return F(e).duration}else{return F(e).duration()}}else{H("SJS: [getDuration] Undefined video element id '"+e+"'");return-1}}function V(e){if(e){if(!I()){return F(e).currentTime}else{return F(e).currentTime()}}else{H("SJS: [getCurrentTime] Undefined video element id '"+e+"'");return-1}}function $(e,t){if(e){var n=X(e);if(n!=-1&&!isNaN(t)&&t>=0&&t<=n){if(!I()){F(e).currentTime=t}else{F(e).currentTime(t)}return true}else{H("SJS: [setCurrentTime] Could not set time for video element id '"+e+"'");$(e,n);return false}}else{H("SJS: [setCurrentTime] Undefined video element id '"+e+"'");return false}}function J(e){if(e){if(!I()){return F(e).playbackRate}else{return F(e).playbackRate()}}else{H("SJS: [getPlaybackRate] Undefined video element id '"+e+"'");return 1}}function K(e,t){if(e){if(!I()){F(e).playbackRate=t}else{F(e).playbackRate(t)}return true}else{H("SJS: [setPlaybackRate] Undefined video element id '"+e+"'");return false}}function Q(e){if(e){if(!I()){return F(e).buffered}else{return F(e).buffered()}}else{H("SJS: [getBufferTimeRange] Undefined video element id '"+e+"'");return undefined}}function G(e){var t=V(E);var n=V(e);if(t!=-1&&n!=-1&&!B(n,t-a,t)){return n-t}return 0}function Y(){for(var t=0;t<g.length;++t){if(g[t]!=E){var n=false;var r=G(g[t]);if(!P){if(r>d){if(Math.abs(r)<f){e(document).trigger("sjs:synchronizing",[V(E),g[t]]);H("SJS: [synchronize] Decreasing playback rate of video element id '"+g[t]+"' from "+J(g[t])+" to "+(J(E)-.5));K(g[t],J(E)+c)}else{e(document).trigger("sjs:synchronizing",[V(E),g[t]]);K(g[t],J(E));n=true}}else if(r<v){if(Math.abs(r)<f){e(document).trigger("sjs:synchronizing",[V(E),g[t]]);H("SJS: [synchronize] Increasing playback rate of video element id '"+g[t]+"' from "+J(g[t])+" to "+(J(E)-.5));K(g[t],J(E)+l)}else{e(document).trigger("sjs:synchronizing",[V(E),g[t]]);K(g[t],J(E));n=true}}else if(!W(E)&&!D[g[t]]){K(g[t],J(E));H("SJS: [synchronize] Playing video element id '"+g[t]+"'");R(g[t])}}else if(P){if(Math.abs(r)>synchDelayThreshold&&Math.abs(r)>p){n=true}else if(!W(E)&&!D[g[t]]){H("SJS: [synchronize] Playing video element id '"+g[t]+"'");R(g[t])}}if(n){e(document).trigger("sjs:synchronizing",[V(E),g[t]]);H("SJS: [synchronize] Seeking video element id '"+g[t]+"': "+(V(E)+h));if($(g[t],V(E)+h)){R(g[t]);if(!W(E)&&!D[g[t]]){H("SJS: [synchronize] Playing video element id '"+g[t]+"' after seeking");R(g[t])}else{H("SJS: [synchronize] Pausing video element id '"+g[t]+"' after seeking");z(g[t])}}}}}}function Z(e,t){H("SJS: [syncPause] Synchronizing. Pausing video id '"+e+"' for "+t/J(E)+"s");D[e]=true;z(e);setTimeout(function(){D[e]=false;if(!W(E)){R(e);H("SJS: [syncPause] Synchronizing. Continuing to play video id '"+e+"' after "+t+"s")}else{H("SJS: [syncPause] Still pausing video id '"+e+"' after "+t+"s, as the master video is paused, too")}},t/J(E)*1e3)}function et(){if(it()){var n=j(E);P=e("#"+E+"_flash_api").length!=0;n.on("play",function(){H("SJS: Master received 'play' event");e(document).trigger("sjs:masterPlay",[V(E)]);L=false;if(!T&&t){T=true;tt()}for(var n=0;n<g.length;++n){if(g[n]!=E){R(g[n]);U(g[n])}}});n.on("pause",function(){H("SJS: Master received 'pause' event");e(document).trigger("sjs:masterPause",[V(E)]);L=!k&&C;k=k?!k:k;for(var t=0;t<g.length;++t){if(g[t]!=E){z(g[t]);Y()}}});n.on("ratechange",function(){H("SJS: Master received 'ratechange' event");e(document).trigger("sjs:masterPlaybackRateChanged",[J(E)]);for(var t=0;t<g.length;++t){if(g[t]!=E){K(g[t],J(E))}}});n.on("ended",function(){H("SJS: Master received 'ended' event");e(document).trigger("sjs:masterEnded",[X(E)]);L=true;for(var t=0;t<g.length;++t){if(g[t]!=E){Y();z(g[t])}}});n.on("timeupdate",function(){e(document).trigger("sjs:masterTimeupdate",[V(E)]);L=true;var t=Date.now();if(t-o>u||W(E)){o=t;var n;var r;for(var i=0;i<g.length;++i){if(g[i]!=E){U(g[i]);r=W(g[i]);Y()}}}})}else{for(var r=0;r<g.length;++r){z(g[r])}}}function tt(){N=window.setInterval(function(){var t=true;var n=V(E);for(var r=0;r<g.length;++r){var s=Q(g[r]);if(s){var o=X(g[r]);var u=V(g[r])+i;var a=false;for(var f=0;f<s.length&&!a;++f){u=u>=o?o:u;if(B(u,s.start(f),s.end(f))){a=true}}t=t&&a}else{}}if(!t){C=true;k=true;for(var r=0;r<g.length;++r){z(g[r])}L=false;e(document).trigger("sjs:buffering",[])}else if(C&&!L){C=false;R(E);L=false;e(document).trigger("sjs:bufferedAndAutoplaying",[])}else if(C){C=false;e(document).trigger("sjs:bufferedButNotAutoplaying",[])}},n)}function nt(t){w=t<g.length?t:0;E=g[w];e(document).trigger("sjs:masterSet",[E])}function rt(e,t){if(e!=""){j(e).on("loadeddata",function(){M=true;if(t){t()}})}else{H("SJS: [doWhenDataLoaded] Undefined video element id '"+e+"'")}}function it(){if(!I()){return S==g.length}else{for(var e=0;e<g.length;++e){if(!b[g[e]]){return false}}return true}}function st(){if(!I()){return S==g.length}else{for(var e=0;e<g.length;++e){if(!y[g[e]]){return false}}return true}}function ot(){var e=this;for(var t=0;t<g.length;++t){z(g[t])}x=true}function ut(){var e=this;for(var t=0;t<g.length;++t){z(g[t])}x=false}function at(){if(A!=null){window.clearInterval(A);A=null}}var t=true;var n=1e3;var r=5e3;var i=2;var s=true;var o=0;var u=1e3;var a=1;var f=4;var l=.5;var c=-.5;var h=.25;var p=h+.05;var d=.05;var v=-.05;var m=false;var g=[];var y={};var b={};var w=0;var E;var S=0;var x=false;var T=false;var N;var C=false;var k=false;var L=false;var A=null;var O=1e4;var M=false;var _=null;var D=[];var P=false;e.synchronizeVideos=function(t,n,i){var o=true;if(arguments.length==2){var u=e('video[mediagroup="'+n+'"]');for(var a=0;a<u.length;++a){var f=g.length;g[f]=u[a].getAttribute("id");var l="_html5_api";g[f]=I()&&g[f].indexOf(l)!=-1?g[f].substr(0,g[f].length-l.length):g[f];y[g[a-1]]=false;b[g[a-1]]=false}}else{w=t;for(var a=1;a<arguments.length;++a){o=o&&arguments[a]&&e("#"+arguments[a]).length;if(!o){e(document).trigger("sjs:invalidId",[arguments[a]])}else{g[g.length]=arguments[a];y[g[a-1]]=false;b[g[a-1]]=false}}}if(o&&g.length>1){if(!I()){for(var a=0;a<g.length;++a){e(document).trigger("sjs:idRegistered",[g[a]]);var c=t;j(g[a]).on("play",ot);j(g[a]).on("pause",ut);j(g[a]).ready(function(){++S;if(it()){nt(c);for(var t=0;t<g.length;++t){j(g[t]).off("play",ot);j(g[t]).off("pause",ut)}et();if(x){R(E)}e(document).trigger("sjs:allPlayersReady",[])}})}}else{for(var a=0;a<g.length;++a){e(document).trigger("sjs:idRegistered",[g[a]]);var c=t;j(g[a]).on("play",ot);j(g[a]).on("pause",ut);j(g[a]).ready(function(){var t=q(this);y[t]=true;rt(t,function(){b[t]=true;e(document).trigger("sjs:playerLoaded",[t]);if(it()){nt(c);for(var n=0;n<g.length;++n){j(g[n]).off("play",ot);j(g[n]).off("pause",ut)}et();if(x){R(E)}e(document).trigger("sjs:allPlayersReady",[])}});_=window.setInterval(function(){if(!M){for(var e=0;e<g.length;++e){j(g[e]).trigger("loadeddata")}}else{window.clearInterval(_);_=null}},r)})}}}else{H("SJS: Not enough videos");e(document).trigger("sjs:notEnoughVideos",[])}if(s){e(document).on("sjs:buffering",function(e){H("SJS: Received 'sjs:buffering' event");A=setInterval(function(){if(it()&&!L){R(E)}},O)});e(document).on("sjs:bufferedAndAutoplaying",function(e){H("SJS: Received 'sjs:bufferedAndAutoplaying' event");at()});e(document).on("sjs:bufferedButNotAutoplaying",function(e){H("SJS: Received 'sjs:bufferedButNotAutoplaying' event");at()})}e(document).on("sjs:play",function(e){H("SJS: Received 'sjs:play' event");if(it()){R(E)}});e(document).on("sjs:pause",function(e){H("SJS: Received 'sjs:pause' event");if(it()){z(E)}});e(document).on("sjs:setCurrentTime",function(e,t){H("SJS: Received 'sjs:setCurrentTime' event");if(it()){$(E,t)}});e(document).on("sjs:synchronize",function(e){H("SJS: Received 'sjs:synchronize' event");if(it()){Y()}});e(document).on("sjs:startBufferChecker",function(e){H("SJS: Received 'sjs:startBufferChecker' event");if(!T){window.clearInterval(N);T=true;tt()}});e(document).on("sjs:stopBufferChecker",function(e){H("SJS: Received 'sjs:stopBufferChecker' event");window.clearInterval(N);T=false})};e(document).on("sjs:debug",function(e,t){m=t;H("SJS: Received 'sjs:debug' event")})})(jQuery)