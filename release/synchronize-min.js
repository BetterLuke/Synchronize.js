/**
 * Synchronize.js
 * Version 1.2.0
 *
 * Copyright 2013-2014 Denis Meyer
 */
(function(e){function M(e){if(t&&window.console){console.log(e)}}function _(e,t,n){if(!isNaN(e)&&!isNaN(t)&&!isNaN(n)&&t<=n){return e>=t&&e<=n}else{return false}}function D(t){if(t){if(!H()){return e("#"+t)}else{return videojs(t)}}else{M("SJS: [getVideoObj] Undefined video element id '"+t+"'");return undefined}}function P(e){if(e){if(!H()){return D(e).get(0)}else{return videojs(e)}}else{M("SJS: [getVideo] Undefined video element id '"+e+"'");return undefined}}function H(){return!(typeof videojs==="undefined")}function B(e){if(H()&&e){var t=e.id();return t!=""?t:e}else{return e}}function j(e){if(e){M("SJS: [play] Playing video element id '"+e+"'");P(e).play();return true}else{M("SJS: [play] Undefined video element id '"+e+"'");return false}}function F(e){if(e){M("SJS: [mute] Muting video element id '"+e+"'");if(!H()){P(e).muted=true}else{P(e).volume(0)}}else{M("SJS: [mute] Undefined video element id '"+e+"'");return undefined}}function I(e){if(e){M("SJS: [pause] Pausing video element id '"+e+"'");return P(e).pause()}else{M("SJS: [pause] Undefined video element id '"+e+"'");return false}}function q(e){if(e){if(!H()){return P(e).paused}else{return P(e).paused()}}else{M("SJS: [isPaused] Undefined video element id '"+e+"'");return false}}function R(e){if(e){if(!H()){return P(e).duration}else{return P(e).duration()}}else{M("SJS: [getDuration] Undefined video element id '"+e+"'");return-1}}function U(e){if(e){if(!H()){return P(e).currentTime}else{return P(e).currentTime()}}else{M("SJS: [getCurrentTime] Undefined video element id '"+e+"'");return-1}}function z(e,t){if(e){var n=R(e);if(n!=-1&&!isNaN(t)&&t>=0&&t<=n){if(!H()){P(e).currentTime=t}else{P(e).currentTime(t)}return true}else{M("SJS: [setCurrentTime] Could not set time for video element id '"+e+"'");z(e,n);return false}}else{M("SJS: [setCurrentTime] Undefined video element id '"+e+"'");return false}}function W(e){if(e){if(!H()){return P(e).playbackRate}else{return P(e).playbackRate()}}else{M("SJS: [getPlaybackRate] Undefined video element id '"+e+"'");return 1}}function X(e,t){if(e){if(!H()){P(e).playbackRate=t}else{P(e).playbackRate(t)}return true}else{M("SJS: [setPlaybackRate] Undefined video element id '"+e+"'");return false}}function V(e){if(e){if(!H()){return P(e).buffered}else{return P(e).buffered()}}else{M("SJS: [getBufferTimeRange] Undefined video element id '"+e+"'");return undefined}}function $(e){var t=U(o);var n=U(e);if(t!=-1&&n!=-1&&!_(n,t-l,t)){return n-t}return 0}function J(){for(var t=0;t<n.length;++t){if(n[t]!=o){var r=$(n[t]);if(Math.abs(r)>p){e(document).trigger("sjs:synchronizing",[U(o),n[t]]);var i=false;if(!O){M("SJS: [synchronize] Synchronizing video element id '"+n[t]+"', delay = "+r);if(r>p){if(W(o)!=W(n[t])){X(n[t],W(o));if(!q(o)&&!A[n[t]]){j(n[t]);M("SJS: [synchronize] Restarting video element id '"+n[t]+"' as it paused unexpectedly")}}if(r<c){K(n[t],r)}else{i=true}}else if(r<p){if(Math.abs(r)<c){M("SJS: [synchronize] Synchronizing. Increased playback speed of video element id '"+n[t]+"' to "+W(n[t]));X(n[t],W(o)+.5)}else{i=true}}}else{i=true}if(i){M("SJS: Synchronizing. Seeking: "+(U(o)+h));if(!z(n[t],U(o)+h)){}else{if(!q(o)){M("SJS: [synchronize] Playing video element id '"+n[t]+"' after seeking");j(n[t])}else{M("SJS: [synchronize] Pausing video element id '"+n[t]+"' after seeking, as the master video is paused, too");I(n[t])}}}}}}}function K(e,t){M("SJS: [syncPause] Synchronizing. Pausing video id '"+e+"' for "+t/W(o)+"s");A[e]=true;I(e);setTimeout(function(){A[e]=false;if(!q(o)){j(e);M("SJS: [syncPause] Synchronizing. Continuing to play video id '"+e+"' after "+t+"s")}else{M("SJS: [syncPause] Still pausing video id '"+e+"' after "+t+"s, as the master video is paused, too")}},t/W(o)*1e3)}function Q(){if(et()){var t=D(o);O=e("#"+o+"_flash_api").length!=0;t.on("play",function(){M("SJS: Master received 'play' event");e(document).trigger("sjs:masterPlay",[U(o)]);E=false;if(!m&&v){m=true;G()}for(var t=0;t<n.length;++t){if(n[t]!=o){j(n[t]);F(n[t])}}});t.on("pause",function(){M("SJS: Master received 'pause' event");e(document).trigger("sjs:masterPause",[U(o)]);E=!w&&b;w=w?!w:w;for(var t=0;t<n.length;++t){if(n[t]!=o){I(n[t]);J()}}});t.on("ratechange",function(){M("SJS: Master received 'ratechange' event");e(document).trigger("sjs:masterPlaybackRateChanged",[W(o)]);for(var t=0;t<n.length;++t){if(n[t]!=o){X(n[t],W(o))}}});t.on("ended",function(){M("SJS: Master received 'ended' event");e(document).trigger("sjs:masterEnded",[R(o)]);E=true;for(var t=0;t<n.length;++t){if(n[t]!=o){J();I(n[t])}}});t.on("timeupdate",function(){e(document).trigger("sjs:masterTimeupdate",[U(o)]);E=true;var t=Date.now();if(t-a>f||q(o)){a=t;var r;var i;for(var s=0;s<n.length;++s){if(n[s]!=o){F(n[s]);i=q(n[s]);J()}}}})}else{for(var r=0;r<n.length;++r){I(n[r])}}}function G(){g=window.setInterval(function(){var t=true;var r=U(o);for(var i=0;i<n.length;++i){var s=V(n[i]);if(s){var u=R(n[i]);var a=U(n[i])+S;var f=false;for(var l=0;l<s.length&&!f;++l){a=a>=u?u:a;if(_(a,s.start(l),s.end(l))){f=true}}t=t&&f}else{}}if(!t){b=true;w=true;for(var i=0;i<n.length;++i){I(n[i])}E=false;e(document).trigger("sjs:buffering",[])}else if(b&&!E){b=false;j(o);E=false;e(document).trigger("sjs:bufferedAndAutoplaying",[])}else if(b){b=false;e(document).trigger("sjs:bufferedButNotAutoplaying",[])}},y)}function Y(t){s=t<n.length?t:0;o=n[s];e(document).trigger("sjs:masterSet",[o])}function Z(e,t){if(e!=""){D(e).on("loadeddata",function(){C=true;if(t){t()}})}else{M("SJS: [doWhenDataLoaded] Undefined video element id '"+e+"'")}}function et(){if(!H()){return u==n.length}else{for(var e=0;e<n.length;++e){if(!i[n[e]]){return false}}return true}}function tt(){if(!H()){return u==n.length}else{for(var e=0;e<n.length;++e){if(!r[n[e]]){return false}}return true}}function nt(){var e=this;for(var t=0;t<n.length;++t){I(n[t])}d=true}function rt(){var e=this;for(var t=0;t<n.length;++t){I(n[t])}d=false}function it(){if(T!=null){window.clearInterval(T);T=null}}var t=false;var n=[];var r={};var i={};var s=0;var o;var u=0;var a=0;var f=1500;var l=1;var c=5;var h=.5;var p=0;var d=false;var v=true;var m=false;var g;var y=1e3;var b=false;var w=false;var E=false;var S=2;var x=true;var T=null;var N=1e4;var C=false;var k=null;var L=5e3;var A=[];var O=false;e.synchronizeVideos=function(a,f,l){var c=true;if(arguments.length==2){var h=e('video[mediagroup="'+f+'"]');for(var p=0;p<h.length;++p){var v=n.length;n[v]=h[p].getAttribute("id");var y="_html5_api";n[v]=H()&&n[v].indexOf(y)!=-1?n[v].substr(0,n[v].length-y.length):n[v];r[n[p-1]]=false;i[n[p-1]]=false}}else{s=a;for(var p=1;p<arguments.length;++p){c=c&&arguments[p]&&e("#"+arguments[p]).length;if(!c){e(document).trigger("sjs:invalidId",[arguments[p]])}else{n[n.length]=arguments[p];r[n[p-1]]=false;i[n[p-1]]=false}}}if(c&&n.length>1){if(!H()){for(var p=0;p<n.length;++p){e(document).trigger("sjs:idRegistered",[n[p]]);var b=a;D(n[p]).on("play",nt);D(n[p]).on("pause",rt);D(n[p]).ready(function(){++u;if(et()){Y(b);for(var t=0;t<n.length;++t){D(n[t]).off("play",nt);D(n[t]).off("pause",rt)}Q();if(d){j(o)}e(document).trigger("sjs:allPlayersReady",[])}})}}else{for(var p=0;p<n.length;++p){e(document).trigger("sjs:idRegistered",[n[p]]);var b=a;D(n[p]).on("play",nt);D(n[p]).on("pause",rt);D(n[p]).ready(function(){var t=B(this);r[t]=true;Z(t,function(){i[t]=true;e(document).trigger("sjs:playerLoaded",[t]);if(et()){Y(b);for(var r=0;r<n.length;++r){D(n[r]).off("play",nt);D(n[r]).off("pause",rt)}Q();if(d){j(o)}e(document).trigger("sjs:allPlayersReady",[])}});k=window.setInterval(function(){if(!C){for(var e=0;e<n.length;++e){D(n[e]).trigger("loadeddata")}}else{window.clearInterval(k);k=null}},L)})}}}else{M("SJS: Not enough videos");e(document).trigger("sjs:notEnoughVideos",[])}if(x){e(document).on("sjs:buffering",function(e){M("SJS: Received 'sjs:buffering' event");T=setInterval(function(){if(et()&&!E){j(o)}},N)});e(document).on("sjs:bufferedAndAutoplaying",function(e){M("SJS: Received 'sjs:bufferedAndAutoplaying' event");it()});e(document).on("sjs:bufferedButNotAutoplaying",function(e){M("SJS: Received 'sjs:bufferedButNotAutoplaying' event");it()})}e(document).on("sjs:play",function(e){M("SJS: Received 'sjs:play' event");if(et()){j(o)}});e(document).on("sjs:pause",function(e){M("SJS: Received 'sjs:pause' event");if(et()){I(o)}});e(document).on("sjs:setCurrentTime",function(e,t){M("SJS: Received 'sjs:setCurrentTime' event");if(et()){z(o,t)}});e(document).on("sjs:debug",function(e,n){M("SJS: Received 'sjs:debug' event");t=n});e(document).on("sjs:synchronize",function(e){M("SJS: Received 'sjs:synchronize' event");if(et()){J()}});e(document).on("sjs:startBufferChecker",function(e){M("SJS: Received 'sjs:startBufferChecker' event");if(!m){window.clearInterval(g);m=true;G()}});e(document).on("sjs:stopBufferChecker",function(e){M("SJS: Received 'sjs:stopBufferChecker' event");window.clearInterval(g);m=false})}})(jQuery)